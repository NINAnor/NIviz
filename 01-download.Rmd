# Downloading and preparing example data 

```{r Load library, eval = TRUE, message = FALSE, warning = FALSE}
library(NIcalc)
```

Fill in your username (NINA email) and password.
```{r Run locally, eval = FALSE}

myUser <- "user@nina.no" # insert NINA email
myPwd  <- "" # secret password

```

Choose which indicator(s) you want, use the NIcalc "importDatasetApi" function to retrieve data from the database and save the dataset locally.

```{r}
indicator <- c("Dikesoldogg",
               "Jerv",
               "Elg",
               "Lomvi",
               "HavÃ¸rn",
               "Lange")

```

```{r , eval = FALSE, message = FALSE}
for(i in indicator){
indicatorImport <- NULL
indicatorImport <- NIcalc::importDatasetApi(
  username = myUser,
  password = myPwd,
  indic = i,
  year = c("1990","2000","2010","2014","2019"))

assign(paste0(i, "_import"), indicatorImport)
}


```

```{r, eval=F}
path <- "P:/41201612_naturindeks_2021_2023_database_og_innsynslosning/temp/"

for(i in indicator){
  temp <- get(paste0(i, "_import"))
  saveRDS(temp, paste0(path, i, "_import.rds"))
}

for(i in indicator){
  temp <- paste0(path, i, "_import.rds")
  assign(i, readRDS(temp))
}
```

Next, I need to assemble the data set. This shouldn't be necessary since all the data is already present. But One thing I notices was that for jerv, the distribution familiy and parameters only appear after assembling.

```{r, message=F, warning=F}
# Spesify all of Norway incl the five regions, som NIunits:
myNIunits <- c(allArea = T, parts = T, counties = F)
# Include all BSunits (kommuner) irrespective of the proportion of the main ecosystems:
myPartOfTotal <- 0

for(i in indicator){

  temp <- get(paste0(i, "_import"))
  assemeble <- NULL
  assemeble <- NIcalc::assembleNiObject(
    inputData = temp,
    predefNIunits = myNIunits, 
    partOfTotal = myPartOfTotal, 
    indexType = "thematic",
    part = "ecosystem",
    total = "total")  
  
  # I dont se the output changing if I for example chose total = marine. Perhaps 'part' and 'total' only becomes an issue if partOfTotal != 0.
  
  assign(paste0(i, "_assemble"), assemeble)

}


```


Save the files 
```{r, eval = F}

for(i in indicator){
  temp <- get(paste0(i, "_assemble"))
  saveRDS(temp, paste0("data/", i, "_assemebled.rds"))
}

```




Loading the datafiles back into R.
```{r}
for(i in indicator){
  temp <- paste0("data/", i, "_assemebled.rds")
  assign(i, readRDS(temp))
}
```


```{r, eval =F}
myYears <- as.character(c(1990,2000,2010,2014,2019))

for(j in indicator){
  temp_comb <- data.frame(NULL)
  temp <- get(j)
  temp2 <- get(paste0(j, "_import"))
  
  for(i in 1:length(myYears)){
print(j)
print(i)

obs <- NULL
  obs <- temp$indicatorValues[[i]]$distributionFamilyName
  obs[!is.na(obs)] <- "tradObs"
  obs[is.na(obs)]  <- "customObs"
  #obstype[[i]] <- obs
  

myMat <- NIcalc::sampleObsMat(
  ICunitId           = temp$indicatorValues[[i]]$ICunitId, 
  value              = temp$indicatorValues[[i]]$expectedValue,
  distrib            = temp$indicatorValues[[i]]$distributionFamilyName,
  mu                 = temp$indicatorValues[[i]]$distParameter1,
  sig                = temp$indicatorValues[[i]]$distParameter2,
  customDistribution = temp$indicatorValues[[i]]$customDistribution,
  obsType            = obs,
  nsim               = 1000
          
)

myMat2 <- as.data.frame(myMat)

myMat2 <- myMat2 %>%
  tibble::add_column(.before=1,
    ICunitID = row.names(myMat))

myMat2 <- myMat2 %>%
  tibble::add_column(.after = 1,
    ICunitName = temp2$ICunits$name[match(
      myMat2$ICunitID, temp2$ICunits$id)],
    year = myYears[i]) 

temp_comb <- rbind(temp_comb, myMat2)

assign(paste0(j, "_bootstrapped"), temp_comb)
 }
}

```

Save the files 
```{r, eval = F}

for(i in indicator){
  temp <- get(paste0(i, "_bootstrapped"))
  saveRDS(temp, paste0("data/", i, "_bootstrapped.rds"))
}

```
